{% extends "shared/base.html" %} {% block title %}Admin Dashboard - Sistem Aircraft Maintenance{% endblock %} {# [DIPERBARUI] Impor macro diletakkan di sini #} {% from "components/tracking_list.html" import render_tracking_list %} {% block
content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Style untuk menyorot kartu yang urgen */
  .is-urgent {
    border: 2px solid #ef4444;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
  }
</style>

<div class="min-h-screen bg-gray-50">
  <div class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center">
          <div class="bg-blue-600 p-3 rounded-lg mr-4"><i class="fas fa-user-shield text-white text-xl"></i></div>
          <div>
            <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Admin Dashboard</h1>
          </div>
        </div>
        <div class="relative">
          <button id="user-menu-button" class="flex items-center space-x-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
            <div class="flex flex-col items-start">
              <span class="font-medium text-sm text-gray-800">{{ user.name }}</span>
              <span class="text-xs text-gray-500">{{ user.position }}</span>
            </div>
            <i class="fas fa-chevron-down text-xs text-gray-600"></i>
          </button>
          <div id="user-menu" class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50 hidden ring-1 ring-black ring-opacity-5">
            <div class="px-4 py-3">
              <p class="text-sm font-semibold text-gray-900">{{ user.name }}</p>
              <p class="text-sm text-gray-500 truncate">{{ user.position }}</p>
            </div>
            <div class="border-t border-gray-100"></div>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Profil</a>
            <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Pengaturan</a>
            <div class="border-t border-gray-100"></div>
            <a href="{{ url_for('logout') }}" onclick="return confirmLogout()" class="block w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50">Logout</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-sm border card-hover flex flex-col justify-between">
        <div>
          <div class="flex items-center mb-4">
            <div class="p-3 bg-blue-100 rounded-lg mr-4"><i class="fas fa-plus-circle text-blue-600 text-xl"></i></div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">Buat MWS Baru</h3>
              <p class="text-sm text-gray-600">Tambah MWS</p>
            </div>
          </div>
        </div>
        <a href="{{ url_for('create_mws') }}" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-center font-medium">Buat MWS</a>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border card-hover flex flex-col justify-between">
        <div>
          <div class="flex items-center mb-4">
            <div class="p-3 bg-green-100 rounded-lg mr-4"><i class="fas fa-users-cog text-green-600 text-xl"></i></div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">Kelola Tim</h3>
              <p class="text-sm text-gray-600">Kelola Pengguna</p>
            </div>
          </div>
        </div>
        <a href="{{ url_for('manage_users') }}" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg text-center font-medium">Kelola Pengguna</a>
      </div>
      <div class="bg-white p-6 rounded-xl shadow-sm border card-hover flex flex-col justify-between">
        <div>
          <div class="flex items-center mb-4">
            <div class="p-3 bg-purple-100 rounded-lg mr-4"><i class="fas fa-signature text-purple-600 text-xl"></i></div>
            <div>
              <h3 class="text-lg font-semibold text-gray-800">Prepared By</h3>
              <p class="text-sm text-gray-600">Tanda Tangan</p>
            </div>
          </div>
        </div>
        {% set unsigned_parts_count = parts.values()|selectattr('preparedBy', 'equalto', '')|list|length %}
        <div class="bg-gray-50 text-center py-2 rounded-lg">
          <span class="text-lg font-bold {% if unsigned_parts_count > 0 %}text-yellow-600{% else %}text-green-600{% endif %}">{{ unsigned_parts_count }}</span><span class="text-sm text-gray-700"> Menunggu Signature</span>
        </div>
      </div>
    </div>

    {% include 'components/status_chart.html' with context %} {{ render_tracking_list(parts, users, user) }}
  </div>
</div>

<div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
    <div class="mt-3 text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i class="fas fa-exclamation-triangle text-red-600 text-xl"></i></div>
      <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Hapus MWS?</h3>
      <div class="mt-2 px-7 py-3">
        <p class="text-sm text-gray-500">Apakah Anda yakin ingin menghapus MWS untuk <strong id="part-to-delete-name" class="font-bold"></strong>? Tindakan ini tidak dapat dibatalkan.</p>
      </div>
      <div class="items-center px-4 py-3">
        <button id="cancel-delete-button" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto shadow-sm hover:bg-gray-300 ml-2">Batal</button
        ><button id="confirm-delete-button" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700">Ya, Hapus</button>
      </div>
    </div>
  </div>
</div>

<script>
  function confirmLogout() {
    return confirm("Apakah Anda yakin ingin logout?");
  }

  document.addEventListener("DOMContentLoaded", function () {
    // Dropdown Menu Profil
    const userMenuButton = document.getElementById("user-menu-button");
    const userMenu = document.getElementById("user-menu");
    if (userMenuButton) {
      userMenuButton.addEventListener("click", function (event) {
        event.stopPropagation();
        userMenu.classList.toggle("hidden");
      });
    }
    window.addEventListener("click", function (event) {
      if (userMenu && !userMenu.classList.contains("hidden") && !userMenuButton.contains(event.target)) {
        userMenu.classList.add("hidden");
      }
    });

    // --- Inisialisasi fitur dari komponen tracking_list ---

    // Logika Modal Hapus
    const deleteModal = document.getElementById("delete-modal");
    const confirmDeleteButton = document.getElementById("confirm-delete-button");
    const cancelDeleteButton = document.getElementById("cancel-delete-button");
    const partToDeleteName = document.getElementById("part-to-delete-name");
    let partIdToDelete = null;

    window.showDeleteModal = function (partId, partName) {
      partIdToDelete = partId;
      partToDeleteName.textContent = partName;
      if (deleteModal) deleteModal.classList.remove("hidden");
    };

    if (cancelDeleteButton) {
      cancelDeleteButton.addEventListener("click", () => deleteModal.classList.add("hidden"));
    }

    if (confirmDeleteButton) {
      confirmDeleteButton.addEventListener("click", () => {
        if (partIdToDelete) {
          fetch(`/delete_mws/${partIdToDelete}`, { method: "DELETE" })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                location.reload();
              } else {
                alert("Gagal menghapus: " + data.error);
              }
            })
            .catch((err) => console.error(err));
        }
        deleteModal.classList.add("hidden");
      });
    }

    // Logika Tombol Urgent
    const partsContainer = document.getElementById("parts-container");
    if (partsContainer) {
      const urgentButtons = document.querySelectorAll(".urgent-btn");
      function sortParts() {
        const partCards = Array.from(partsContainer.children);
        partCards.sort((a, b) => {
          const aIsUrgent = a.classList.contains("is-urgent");
          const bIsUrgent = b.classList.contains("is-urgent");
          if (aIsUrgent && !bIsUrgent) return -1;
          if (!aIsUrgent && bIsUrgent) return 1;
          return parseInt(a.dataset.originalOrder) - parseInt(b.dataset.originalOrder);
        });
        partCards.forEach((card) => partsContainer.appendChild(card));
      }
      urgentButtons.forEach((button) => {
        button.addEventListener("click", function () {
          const partCard = this.closest(".part-card");
          partCard.classList.toggle("is-urgent");
          if (partCard.classList.contains("is-urgent")) {
            this.textContent = "CANCEL URGENT";
            this.className = "urgent-btn px-3 py-2 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-lg transition-colors";
          } else {
            this.textContent = "URGENT!";
            this.className = "urgent-btn px-3 py-2 bg-yellow-400 hover:bg-yellow-500 text-yellow-800 text-xs font-bold rounded-lg transition-colors";
          }
          sortParts();
        });
      });
    }
  });
</script>
{% endblock %}
