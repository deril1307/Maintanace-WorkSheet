{% macro render_tracking_list(parts, users, current_user) %}
<div class="bg-white rounded-xl shadow-sm border border-gray-200">
  <div class="px-6 py-4 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
      {# Judul dinamis berdasarkan role #} {% if current_user.role == 'admin' %}
      <i class="fas fa-list-alt mr-3 text-blue-600"></i>Kelola Semua MWS {% elif current_user.role == 'mechanic' %} <i class="fas fa-tasks mr-3 text-green-600"></i>MWS yang Ditugaskan {% elif current_user.role == 'quality1' %}
      <i class="fas fa-search mr-3 text-orange-600"></i>MWS untuk Inspeksi {% elif current_user.role == 'quality2' %} <i class="fas fa-clipboard-check mr-3 text-purple-600"></i>MWS untuk Verifikasi {# [DITAMBAHKAN] Kondisi untuk Super Admin
      #} {% elif current_user.role == 'superadmin' %} <i class="fas fa-crown mr-3 text-red-600"></i>Supervisi Semua MWS {% endif %}
    </h2>
  </div>
  <div class="p-6">
    {# Filter MWS yang relevan untuk setiap role #} {% set relevant_parts = [] %} {% if current_user.role == 'quality1' %} {% for part_id, part in parts.items() if part.status == 'in_progress' %} {% set _ = relevant_parts.append((part_id,
    part)) %} {% endfor %} {% elif current_user.role == 'quality2' %} {% for part_id, part in parts.items() if part.status == 'completed' %} {% set _ = relevant_parts.append((part_id, part)) %} {% endfor %} {% else %} {% for part_id, part
    in parts.items() %} {% set _ = relevant_parts.append((part_id, part)) %} {% endfor %} {% endif %} {% if relevant_parts %}
    <div id="parts-container" class="space-y-6">
      {% for part_id, part in relevant_parts %}
      <div class="part-card border border-gray-200 rounded-lg card-hover overflow-hidden" data-original-order="{{ loop.index }}">
        <div class="p-5 bg-white">
          <div class="flex flex-col md:flex-row md:justify-between md:items-start">
            <div class="flex-1 mb-4 md:mb-0">
              <div class="flex items-center mb-2 flex-wrap">
                <h3 class="text-lg font-semibold text-gray-800 mr-3">{{ part.partNumber }} - {{ part.tittle.name if part.tittle is mapping else part.tittle }}</h3>
                <span
                  class="px-3 py-1 rounded-full text-xs font-medium {% if part.verifiedBy and part.approvedBy %}bg-red-100 text-red-800 {% elif part.verifiedBy %}bg-purple-100 text-purple-800 {% elif part.status == 'completed' %}bg-green-100 text-green-800 {% elif part.status == 'in_progress' %}bg-yellow-100 text-yellow-800 {% else %}bg-gray-100 text-gray-800{% endif %}"
                >
                  {% if part.approvedBy %}Approved {% elif part.verifiedBy %}Verified {% elif part.status == 'completed' %}Selesai {% elif part.status == 'in_progress' %}Perlu Inspeksi {% else %}Menunggu{% endif %}
                </span>
              </div>
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-1 text-sm text-gray-600">
                <div><span class="font-medium text-gray-500">SN:</span> {{ part.serialNumber }}</div>
                <div><span class="font-medium text-gray-500">Customer:</span> {{ part.customer }}</div>
                <div><span class="font-medium text-gray-500">Target:</span> {{ part.targetDate }}</div>
                <div><span class="font-medium text-gray-500">Mekanik:</span> {% if part.assignedTo and part.assignedTo in users %}{{ users[part.assignedTo].name }}{% else %}-{% endif %}</div>
              </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink-0">
              {% if current_user.role == 'admin' %}
              <button class="urgent-btn px-3 py-2 bg-yellow-400 hover:bg-yellow-500 text-yellow-800 text-xs font-bold rounded-lg">URGENT!</button>
              <a href="{{ url_for('mws_detail', part_id=part_id) }}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-eye mr-2"></i>Kelola</a>
              <button onclick="showDeleteModal('{{ part_id }}', '{{ part.tittle.name if part.tittle is mapping else part.tittle }}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-sm">
                <i class="fas fa-trash-alt"></i>
              </button>
              {% elif current_user.role == 'mechanic' %}
              <a href="{{ url_for('mws_detail', part_id=part_id) }}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-wrench mr-2"></i>Kerjakan</a>
              {% elif current_user.role == 'quality1' %}
              <a href="{{ url_for('mws_detail', part_id=part_id) }}" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-search-plus mr-2"></i>Inspeksi</a>
              {% elif current_user.role == 'quality2' %}
              <a href="{{ url_for('mws_detail', part_id=part_id) }}" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-signature mr-2"></i>Verifikasi</a>

              {# [DITAMBAHKAN] Kondisi Tombol untuk Super Admin #} {% elif current_user.role == 'superadmin' %}
              <a href="{{ url_for('mws_detail', part_id=part_id) }}" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium"><i class="fas fa-user-shield mr-2"></i>Supervisi</a>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="bg-gray-50 p-5 border-t">
          {% if current_user.role == 'quality2' %}
          <div class="flex justify-between items-center text-sm text-gray-600">
            <div class="flex items-center space-x-4">
              <span class="text-green-600"><i class="fas fa-check mr-1"></i>Prepared by: {{ users[part.preparedBy].name if part.preparedBy in users else 'N/A' }}</span>
              <span class="text-green-600"><i class="fas fa-check mr-1"></i>Approved by: {{ users[part.approvedBy].name if part.approvedBy in users else 'N/A' }}</span>
            </div>
            {% if not part.verifiedBy %}<span class="text-purple-600 font-semibold"><i class="fas fa-bell fa-shake mr-1"></i>Menunggu Verifikasi Anda</span> {% else %}<span class="text-gray-500"
              ><i class="fas fa-check-double mr-1"></i>Selesai Diverifikasi</span
            >{% endif %}
          </div>
          {% else %} {% set completed_steps = part.steps|selectattr('status', 'equalto', 'completed')|list|length %} {% set total_steps = part.steps|length if part.steps else 1 %} {% set progress_percentage = (completed_steps / total_steps
          * 100)|round|int %}
          <div class="flex justify-between items-center text-sm text-gray-600 mb-2">
            <span class="truncate pr-4">
              {% if part.status == 'completed' %}<i class="fas fa-check-circle text-green-500 mr-2"></i>Selesai {% elif part.status == 'in_progress' %}<i class="fas fa-clock text-yellow-500 mr-2"></i>Step {{ part.currentStep }} dari {{
              total_steps }} {% else %}<i class="fas fa-pause-circle text-gray-500 mr-2"></i>Menunggu {% endif %}
            </span>
            <span class="font-semibold text-gray-800">{{ progress_percentage }}%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3"><div class="bg-blue-600 h-3 rounded-full" style="width: {{ progress_percentage }}%"></div></div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
      <i class="fas fa-clipboard-check text-gray-300 text-6xl mb-4"></i>
      <h3 class="text-lg font-medium text-gray-900 mb-2">Tidak Ada Tugas</h3>
      <p class="text-base text-gray-500">Kondisi saat ini sesuai dengan filter Anda.</p>
    </div>
    {% endif %}
  </div>
</div>
{% endmacro %}
