{% extends "shared/base.html" %}

{% block title %}MWS {{ part.partNumber }} - Sistem Aircraft Maintenance{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <a href="{{ url_for('dashboard') }}" 
                       class="mr-4 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left text-gray-600"></i>
                    </a>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">
                            MWS: {{ part.partNumber }} - {{ part.tittle.name if part.tittle is mapping else part.tittle }}
                        </h1>
                        <p class="text-gray-600">Serial Number: {{ part.serialNumber }}</p>
                    </div>
                </div>
                <span class="px-4 py-2 rounded-full text-sm font-medium
                    {% if part.status == 'completed' %}bg-green-100 text-green-800
                    {% elif part.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                    {% if part.status == 'completed' %}Selesai
                    {% elif part.status == 'in_progress' %}Sedang Dikerjakan
                    {% else %}Menunggu{% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Informasi MWS</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-4 text-sm">
                <div><label class="block font-semibold text-gray-700 mb-1">Part Number</label><p class="text-gray-900">{{ part.partNumber }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Ref</label><p class="text-gray-900">{{ part.ref }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Jenis Pekerjaan</label><p class="text-gray-900">{{ part.tittle.jobType if part.tittle is mapping else 'N/A' }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Customer</label><p class="text-gray-900">{{ part.customer }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">A/C Type</label><p class="text-gray-900">{{ part.acType }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">WBS No.</label><p class="text-gray-900">{{ part.wbsNo }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Worksheet No.</label><p class="text-gray-900">{{ part.worksheetNo }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">IWO No.</label><p class="text-gray-900">{{ part.iwoNo }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Shop Area</label><p class="text-gray-900">{{ part.shopArea }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Revision</label><p class="text-gray-900">{{ part.revision }}</p></div>
                <div><label class="block font-semibold text-gray-700 mb-1">Target Date</label><p class="text-gray-900">{{ part.targetDate }}</p></div>
            </div>
            {% if user.role in ['admin', 'superadmin'] %}
            <div class="mt-6 pt-4 border-t border-gray-200">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Tugaskan ke Mechanic</label>
                <select onchange="assignPart('{{ part_id }}', this.value)" class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Pilih Mechanic</option>
                    {% for nik, user_data in users.items() %}
                        {% if user_data.role == 'mechanic' %}<option value="{{ nik }}" {% if part.assignedTo == nik %}selected{% endif %}>{{ user_data.name }} ({{ nik }})</option>{% endif %}
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200"><h2 class="text-xl font-semibold text-gray-800">Maintenance Work Sheet</h2></div>
            <div class="overflow-x-auto">
                <table class="worksheet-table w-full">
                    <thead class="bg-gray-50"><tr><th class="w-12">NO</th><th class="w-1/2">DESCRIPTION</th><th class="w-20">MAN</th><th class="w-20">HOURS</th><th class="w-20">TECH</th><th class="w-20">INSP</th><th class="w-28">STATUS</th></tr></thead>
                    <tbody>
                        {% for step in part.steps %}
                        <tr class="{% if step.status == 'completed' %}bg-green-50{% elif step.status == 'in_progress' %}bg-yellow-50{% else %}bg-white{% endif %} hover:bg-gray-50">
                            <td class="text-center font-medium p-3 align-top border-b">{{ step.no }}</td>
                            <td class="text-sm p-3 align-top border-b">
                                <div class="font-semibold text-gray-800">{{ step.description }}</div>
                                <div id="details-list-{{ step.no }}" class="mt-2 pl-4">
                                    <ul class="list-disc list-inside text-gray-600 space-y-1">
                                        {% for detail in step.details %}<li id="detail-item-{{ step.no }}-{{ loop.index0 }}"><span id="detail-text-{{ step.no }}-{{ loop.index0 }}">{{ detail }}</span>{% if user.role == 'admin' %}<button onclick="editDetail('{{ part_id }}', {{ step.no }}, {{ loop.index0 }})" class="ml-2 text-blue-500 hover:text-blue-700 text-xs font-semibold">(Edit)</button><button onclick="deleteDetail('{{ part_id }}', {{ step.no }}, {{ loop.index0 }})" class="ml-1 text-red-500 hover:text-red-700 text-xs font-semibold">(Hapus)</button>{% endif %}</li>{% endfor %}
                                    </ul>
                                </div>
                                {% if user.role == 'admin' %}<div class="mt-3 pt-3 border-t border-gray-100"><input type="text" id="new-detail-input-{{ step.no }}" class="w-full border rounded px-2 py-1 text-sm" placeholder="Tambah catatan baru..."><button onclick="addDetail('{{ part_id }}', {{ step.no }})" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded hover:bg-blue-600">Tambah Catatan</button></div>{% endif %}
                            </td>
                            <td class="p-1 align-top border-b"><input type="text" id="man-{{ step.no }}" class="w-full rounded border-gray-300" value="{% if user.role == 'mechanic' or step.status in ['in_progress', 'completed'] %}{{ step.man }}{% endif %}" {% if user.role == 'mechanic' and part.assignedTo == user.nik %} onchange="updateStepField('{{ part_id }}', {{ step.no }}, 'man', this.value)" {% else %} disabled class="bg-gray-100 border-transparent text-center" {% endif %}></td>
                            <td class="p-1 align-top border-b"><input type="text" id="hours-{{ step.no }}" class="w-full rounded border-gray-300" value="{% if user.role == 'mechanic' or step.status in ['in_progress', 'completed'] %}{{ step.hours }}{% endif %}" {% if user.role == 'mechanic' and part.assignedTo == user.nik %} onchange="updateStepField('{{ part_id }}', {{ step.no }}, 'hours', this.value)" {% else %} disabled class="bg-gray-100 border-transparent text-center" {% endif %}></td>
                            <td class="p-1 align-top border-b"><input type="text" id="tech-{{ step.no }}" class="w-full rounded border-gray-300" value="{% if user.role == 'mechanic' or step.status in ['in_progress', 'completed'] %}{{ step.tech }}{% endif %}" {% if user.role == 'mechanic' and part.assignedTo == user.nik %} onchange="updateStepField('{{ part_id }}', {{ step.no }}, 'tech', this.value)" {% else %} disabled class="bg-gray-100 border-transparent text-center" {% endif %}></td>
                            <td class="p-1 align-top border-b"><input type="text" id="insp-{{ step.no }}" value="{{ step.insp }}" class="w-full rounded border-gray-300" {% if user.role == 'quality1' %} onchange="updateStepField('{{ part_id }}', {{ step.no }}, 'insp', this.value)" {% else %} disabled class="bg-gray-100 border-transparent text-center" {% endif %}></td>
                            <td class="text-center align-top p-3 border-b">
                                {% if step.status == 'completed' %}<i class="fas fa-check-circle text-green-500 text-lg" title="Completed"></i>
                                {% elif step.status == 'in_progress' %}<i class="fas fa-clock text-yellow-500 text-lg" title="In Progress"></i>
                                {% else %}
                                    {% if user.role == 'mechanic' and part.assignedTo == user.nik %}<button onclick="validateAndSubmitToInspector('{{ part_id }}', {{ step.no }})" class="px-2 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs">Kirim ke Inspector</button>
                                    {% else %}<i class="fas fa-circle text-gray-300 text-lg" title="Pending"></i>
                                    {% endif %}
                                {% endif %}
                                {% if step.status == 'in_progress' and user.role == 'quality1' %}<button onclick="updateStepStatus('{{ part_id }}', {{ step.no }}, 'completed')" class="px-2 py-1 bg-green-500 hover:bg-green-600 text-white rounded text-xs ml-1">Done</button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tanggal Pengerjaan</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Start Date</label>
                        {% if user.role == 'mechanic' and part.assignedTo == user.nik %}<input type="date" value="{{ part.startDate }}" onchange="updateDates('{{ part_id }}', 'startDate', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        {% else %}<input type="date" value="{{ part.startDate }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">{% endif %}
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Finish Date</label>
                        {% if user.role == 'mechanic' and part.assignedTo == user.nik %}<input type="date" value="{{ part.finishDate }}" onchange="updateDates('{{ part_id }}', 'finishDate', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        {% else %}<input type="date" value="{{ part.finishDate }}" disabled class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">{% endif %}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Tanda Tangan Digital</h3>
                <div class="space-y-3">
                    <div class="p-3 rounded-lg {% if part.preparedBy %}border-green-200 bg-green-50{% else %}border-gray-200 bg-gray-50{% endif %} border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">Prepared By</h4>
                                {% if part.preparedBy %}<p class="text-sm text-gray-600">{{ users[part.preparedBy].name if part.preparedBy in users else part.preparedBy }} - <span class="text-xs text-gray-500">{{ part.preparedDate }}</span></p>
                                {% else %}<p class="text-sm text-gray-500 italic">Menunggu tanda tangan...</p>{% endif %}
                            </div>
                            {% if user.role == 'admin' and not part.preparedBy %}<button onclick="signDocument('{{ part_id }}', 'prepared')" class="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium">Sign</button>
                            {% elif part.preparedBy %}<i class="fas fa-check-circle text-green-500"></i>{% endif %}
                        </div>
                    </div>
                    <div class="p-3 rounded-lg {% if part.approvedBy %}border-green-200 bg-green-50{% else %}border-gray-200 bg-gray-50{% endif %} border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">Approved By</h4>
                                {% if part.approvedBy %}<p class="text-sm text-gray-600">{{ users[part.approvedBy].name if part.approvedBy in users else part.approvedBy }} - <span class="text-xs text-gray-500">{{ part.approvedDate }}</span></p>
                                {% else %}<p class="text-sm text-gray-500 italic">Menunggu tanda tangan...</p>{% endif %}
                            </div>
                            {% if user.role == 'superadmin' and not part.approvedBy %}<button onclick="signDocument('{{ part_id }}', 'approved')" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-sm font-medium">Sign</button>
                            {% elif part.approvedBy %}<i class="fas fa-check-circle text-green-500"></i>{% endif %}
                        </div>
                    </div>
                    <div class="p-3 rounded-lg {% if part.verifiedBy %}border-green-200 bg-green-50{% else %}border-gray-200 bg-gray-50{% endif %} border">
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-800">Verified By</h4>
                                {% if part.verifiedBy %}<p class="text-sm text-gray-600">{{ users[part.verifiedBy].name if part.verifiedBy in users else part.verifiedBy }} - <span class="text-xs text-gray-500">{{ part.verifiedDate }}</span></p>
                                {% else %}<p class="text-sm text-gray-500 italic">Menunggu tanda tangan...</p>{% endif %}
                            </div>
                            {% if user.role == 'quality2' and not part.verifiedBy %}<button onclick="signDocument('{{ part_id }}', 'verified')" class="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white rounded text-sm font-medium">Sign</button>
                            {% elif part.verifiedBy %}<i class="fas fa-check-circle text-green-500"></i>{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const currentUserRole = "{{ user.role }}";
function showNotification(message, type) { const notification = document.createElement('div'); notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; notification.textContent = message; document.body.appendChild(notification); setTimeout(() => { notification.remove(); }, 3000); }
function updateStepField(partId, stepNo, field, value) { fetch('/update_step_field', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ partId, stepNo, field, value }) }).then(r => r.json()).then(d => d.success ? console.log('Field updated') : showNotification('Error: ' + d.error, 'error')).catch(e => showNotification('Error', 'error')); }
function validateAndSubmitToInspector(partId, stepNo) {
    const manValue = document.getElementById(`man-${stepNo}`).value.trim();
    const hoursValue = document.getElementById(`hours-${stepNo}`).value.trim();
    const techValue = document.getElementById(`tech-${stepNo}`).value.trim();
    if (!manValue || !hoursValue || !techValue) {
        alert('Harap isi field MAN, HOURS, dan TECH sebelum mengirim ke inspector.');
        return;
    }
    updateStepStatus(partId, stepNo, 'in_progress');
}
function updateStepStatus(partId, stepNo, status) {
    if (currentUserRole === 'quality1' && status === 'completed') {
        const manValue = document.getElementById(`man-${stepNo}`).value.trim();
        const hoursValue = document.getElementById(`hours-${stepNo}`).value.trim();
        const techValue = document.getElementById(`tech-${stepNo}`).value.trim();
        const inspValue = document.getElementById(`insp-${stepNo}`).value.trim();
        if (!manValue || !hoursValue || !techValue || !inspValue) {
            alert('Harap isi semua field (MAN, HOURS, TECH, INSP) sebelum menyelesaikan langkah ini.');
            return;
        }
    }
    fetch('/update_step_status', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ partId, stepNo, status }) })
      .then(r => r.json())
      .then(d => {
        if (d.success) { location.reload(); } else { alert('Error: ' + d.error); }
    }).catch(e => alert('Terjadi kesalahan jaringan.')); 
}
function assignPart(partId, assignedTo) { if (!assignedTo) return; fetch('/assign_part', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ partId, assignedTo }) }).then(r => r.json()).then(d => d.success ? location.reload() : alert('Error: ' + d.error)).catch(e => alert('Error')); }
function updateDates(partId, field, value) { fetch('/update_dates', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ partId, field, value }) }).then(r => r.json()).then(d => d.success ? showNotification('Date updated', 'success') : showNotification('Error: ' + d.error, 'error')).catch(e => showNotification('Error', 'error')); }
function signDocument(partId, type) { fetch('/sign_document', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ partId, type }) }).then(r => r.json()).then(d => d.success ? location.reload() : showNotification('Error: ' + d.error, 'error')).catch(e => showNotification('Error', 'error')); }
function addDetail(partId, stepNo) { const input = document.getElementById(`new-detail-input-${stepNo}`); const newDetailText = input.value.trim(); if (!newDetailText) return; const detailsList = document.querySelector(`#details-list-${stepNo} ul`); const existingDetails = Array.from(detailsList.querySelectorAll('li > span')).map(span => span.textContent); const updatedDetails = [...existingDetails, newDetailText]; updateStepDetails(partId, stepNo, updatedDetails, () => { input.value = ''; }); }
function editDetail(partId, stepNo, detailIndex) { const span = document.getElementById(`detail-text-${stepNo}-${detailIndex}`); const currentText = span.textContent; const newText = prompt("Edit catatan:", currentText); if (newText !== null && newText !== currentText) { const detailsList = document.querySelector(`#details-list-${stepNo} ul`); const existingDetails = Array.from(detailsList.querySelectorAll('li > span')).map(span => span.textContent); const updatedDetails = [...existingDetails]; updatedDetails[detailIndex] = newText.trim(); updateStepDetails(partId, stepNo, updatedDetails); } }
function deleteDetail(partId, stepNo, detailIndex) { if (!confirm('Apakah Anda yakin ingin menghapus catatan ini?')) return; const detailsList = document.querySelector(`#details-list-${stepNo} ul`); const existingDetails = Array.from(detailsList.querySelectorAll('li > span')).map(span => span.textContent); const updatedDetails = existingDetails.filter((_, index) => index !== detailIndex); updateStepDetails(partId, stepNo, updatedDetails); }
function updateStepDetails(partId, stepNo, detailsArray, callback) { fetch('/update_step_details', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ partId: partId, stepNo: stepNo, details: detailsArray }) }).then(response => response.json()).then(data => { if (data.success) { const listContainer = document.querySelector(`#details-list-${stepNo} ul`); listContainer.innerHTML = ''; detailsArray.forEach((detail, index) => { const li = document.createElement('li'); li.id = `detail-item-${stepNo}-${index}`; const isAdmin = currentUserRole === 'admin'; li.innerHTML = `<span id="detail-text-${stepNo}-${index}">${detail}</span> ${isAdmin ? `<button onclick="editDetail('${partId}', ${stepNo}, ${index})" class="ml-2 text-blue-500 hover:text-blue-700 text-xs font-semibold">(Edit)</button> <button onclick="deleteDetail('${partId}', ${stepNo}, ${index})" class="ml-1 text-red-500 hover:text-red-700 text-xs font-semibold">(Hapus)</button>` : '' }`; listContainer.appendChild(li); }); if (callback) callback(); showNotification('Catatan berhasil diperbarui', 'success'); } else { showNotification('Error: ' + data.error, 'error'); } }).catch(error => { console.error('Error:', error); showNotification('Terjadi kesalahan.', 'error'); }); }
</script>
{% endblock %}